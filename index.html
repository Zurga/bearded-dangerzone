<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>D3 Project</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js"></script>
		<script src="node_modules/topojson/topojson.min.js"></script>
		<script src="js/colorbrewer.js"></script>
		<link rel="stylesheet" href="css/main.css" />
		<script src="js/d3.slider.js" type="text/javascript"></script>
		<link rel="stylesheet" href="css/d3.slider.css" />
	</head>
	
	<body>
	
		<div id="map"></div>

		<div id="slider"></div>
		
		<script type="text/javascript">
			var height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0),
			    width = height * 0.85,
			    active_prov = d3.select(null);
			    active_gem = d3.select(null);
			    
			var formatNumber = d3.format(",.0f");
			
			var projection = d3.geo.mercator()
			    .scale(height * 11)
			    .translate([width / 2, height / 2])
			    .center([5.4, 52.2]);
			
			var zoom = d3.behavior.zoom()
			    .translate([0, 0])
			    .scale(1)
			    .scaleExtent([1, 8])
			    .on("zoom", zoomed);
						
			var path = d3.geo.path()
			    .projection(projection);    
			
			var radius = d3.scale.sqrt()
			    .domain([0, 1e5])
			    .range([0, 10]);
			
			var svg = d3.select("#map").append("svg")
			    .attr("width", width)
			    .attr("height", height)
				.on("click", stopped, true);
				
			svg.append("rect")
			    .attr("class", "background")
			    .attr("width", width)
			    .attr("height", height)
			    .on("click", reset_to_land);
			    
			var g = svg.append('g');
			var gg = svg.append('g');
			var selected_provincie;
			var selected_provincie_obj;
			
			svg.call(zoom.event);
			
			var vars = [], hash;
			var q = document.URL.split('?')[1];
			if(q != undefined){
				q = q.split('&');
				for(var i = 0; i < q.length; i++){
					hash = q[i].split('=');
					vars.push(hash[1]);
					vars[hash[0]] = hash[1];
				}
			}
			
			/* slider with test data */
			// !!!test data please remove!!!
			var data = {Jaar: [2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014]};
			var colors = d3.scale.category10();
			var min = data.Jaar[0];
			var max = data.Jaar[data.Jaar.length - 1];
			var slider_value = '2006';
			d3.select('#slider')
				.style("width", width + "px")
				.call(d3.slider()
				.scale(d3.scale.ordinal()
					.domain(data.Jaar).rangePoints([0, 1], 0.5))
				.axis(d3.svg.axis())
				.snap(true)
				.value(min)
				.on("slide", function(evt, value){
					slider_value = value;
					d3.selectAll('.gemeente path')
						.transition()
						.style('fill', colors(value)); 
					
					redraw();
				}));
					
			function redraw() {
				
				
			}
			
			d3.json("build/prov.json", function(error, prov) {
				if (error) return console.error(error);
				data_feature = topojson.feature(prov, prov.objects.provgeo).features;
				
				g.attr("class", "provincies")
					.selectAll("path")
					.data(data_feature)
					.enter().append("g")
					.attr("class", "provincie")
					.append("path")
					.on("click", zoom_prov)
					.attr("id", function(d) { return d.properties.PROV_NAME })
					.attr("d", path)
					.attr("fill", "#ccc")
					.append("title")
					.text(function(d) {	return d.properties.PROV_NAME; });
					
			});
			
			function zoom_gem(d) {
				if (active_gem.node() === this) return reset_to_prov();
				
				active_gem.classed("active", false);
				active_gem = d3.select(this).classed("active", true);
				
				var bounds = path.bounds(d),
					dx = bounds[1][0] - bounds[0][0],
					dy = bounds[1][1] - bounds[0][1],
					x = (bounds[0][0] + bounds[1][0]) / 2,
					y = (bounds[0][1] + bounds[1][1]) / 2,
					scale = 0.9 / Math.max(dx / width, dy / height),
					translate = [width / 2 - scale * x, height / 2 - scale * y];
				
				svg.transition()
					.duration(1250)
					.call(zoom.translate(translate).scale(scale).event);
				
			}
			
			function zoom_prov(d) {
				gg.selectAll("path").remove();
				
				selected_provincie = d;
				selected_provincie_obj = this;
				
				active_prov.classed("active_prov", false);
				active_prov = d3.select(this).classed("active_prov", true);
				
				//	var year = d3.select('#slider').value();
				d3.json("gemeente-prov/topo_"+d.id+"_"+slider_value+".json", function(error, gem) {
					if (error) return console.error(error);
					
					d3.json("convert/data/json/15_tot_25_jaar.json", function(error, data) {
						if (error) return console.error(error);
						
						dataset = data[slider_value][d.properties.PROV_NAME];
						
						var values = d3.values(dataset);
						values = values.map(function(d) {
							return +d;
						});
						
						var min = d3.min(values);
						var max = d3.max(values);
						console.log(min + " " + max);
						var colorScale = d3.scale.quantize()
						    .range(colorbrewer.OrRd[8])
						    .domain([min, max]);
						
						gg.attr("fill", "#ccc")
							.selectAll("path")
							.data(topojson.feature(gem, gem.objects[d.id+"_"+slider_value]).features)
							.enter().append("g")
							.attr("class", "gemeente")
							.append("path")
							.on("click", zoom_gem)
							.attr("id", function(d) { return d.properties.name })
							.attr("d", path)
							.attr("fill", function(d) {
								if (dataset[d.properties.statnaam] === undefined) {
									return '#ccc';
								}
								return colorScale(dataset[d.properties.statnaam]);
							})
							.append("title")
							.text(function(d) {
								if (dataset[d.properties.statnaam] === undefined) {
									return d.properties.statnaam + ": Geen data bekend"; 
								}
								return d.properties.statnaam + ": " + dataset[d.properties.statnaam]; 
							});
							
					});
					var bounds = path.bounds(d),
						dx = bounds[1][0] - bounds[0][0],
						dy = bounds[1][1] - bounds[0][1],
						x = (bounds[0][0] + bounds[1][0]) / 2,
						y = (bounds[0][1] + bounds[1][1]) / 2,
						scale = 0.9 / Math.max(dx / width, dy / height),
						translate = [width / 2 - scale * x, height / 2 - scale * y];
					
					svg.transition()
						.duration(1250)
						.call(zoom.translate(translate).scale(scale).event);
					
				});
			}
			
			function reset() {
				// TODO: Verwijderen gemeente paths/groups maar hoofdgroep gemeente laten staan
				gg.selectAll("path").remove();
				
				selected_provincie = null;
				active_gem.classed("active_gem", false);
				active_gem = d3.select(null);
				
				svg.transition()
				  .duration(1250)
				  .call(zoom.translate([0, 0]).scale(1).event);
			}
			
			function reset_to_prov() {
				
				active_gem.classed("active_gem", false);
				active_gem = d3.select(null);
				active_prov.classed("active_prov", false);
				active_prov = d3.select(selected_provincie_obj).classed("active_prov", true);
				
				var bounds = path.bounds(selected_provincie),
					dx = bounds[1][0] - bounds[0][0],
					dy = bounds[1][1] - bounds[0][1],
					x = (bounds[0][0] + bounds[1][0]) / 2,
					y = (bounds[0][1] + bounds[1][1]) / 2,
					scale = 0.9 / Math.max(dx / width, dy / height),
					translate = [width / 2 - scale * x, height / 2 - scale * y];
				
				svg.transition()
					.duration(1250)
					.call(zoom.translate(translate).scale(scale).event);
				
			}
			
			function reset_to_land() {
				reset();
				
				active_prov.classed("active_prov", false);
				active_prov = d3.select(null);
				
				svg.transition()
				  .duration(1250)
				  .call(zoom.translate([0, 0]).scale(1).event);
				
			}
			
			function zoomed() {
				g.style("stroke-width", 1.5 / d3.event.scale + "px");
				g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
				gg.style("stroke-width", 1.5 / d3.event.scale + "px");
				gg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
				
			}
			
			function stopped() {
				if (d3.event.defaultPrevented) d3.event.stopPropagation();
			}
			
			$(document).ready(function() {
				setTimeout(function() {
					jQuery.fn.d3Click = function () {
						this.each(function (i, e) {
							var evt = document.createEvent("MouseEvents");
							evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
							
							e.dispatchEvent(evt);
						});
					};
					
					if (vars.hasOwnProperty("gemeente")) {
						var gemeente = $('#'+vars['gemeente']);
						gemeente.d3Click();
					}
					
				}, 1000);
			});
			
			
		</script>
	</body>
</html>
