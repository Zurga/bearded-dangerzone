<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>D3 Project</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js"></script>
		<script src="node_modules/topojson/topojson.min.js"></script>
		<script src="js/colorbrewer.js"></script>
		<link rel="stylesheet" href="css/main.css" />
		<script src="js/d3.slider.js" type="text/javascript"></script>
		<link rel="stylesheet" href="css/d3.slider.css" />
	</head>
	
	<body>
		<div id="wrapper">
			<div class="column left">
				<div id="map"></div>
	
				<div id="slider"></div>
			</div>
			
			<div class="column right">
			
				<div id="properties">
					<p><strong>Nederland</strong> <span id="provincie"></span> <span id="gemeente"></span></p>
					<p>
						<select id="select_variable" name="select_variable">
							<option value="">Selecteer gegevensbron</option>
						</select>
					</p>
					<p id="description"></p>
				</div>
				
				<div id="visual">
					
					
				</div>
			
			</div>
		</div>
		
		<script type="text/javascript">
            //TODO Variabele naam in de Tooltip
            //TODO 
		$(document).ready(function() {
			
			// Inladen gegevensbronnen in de select
			$.ajax({
			    'async': false,
			    'global': false,
			    'url': 'convert/data/json/expl.json',
			    'dataType': "json"
			}).done(function(data) {
				// Groepen inladen
				$.each(data, function(index) {
					var options = '';
					
				    keys = Object.keys(this),
				    i, len = keys.length;
					
					// Alfabetische volgorde van gegevensbronnen
					keys.sort();
					
					// Options aanmaken
					for (i = 0; i < len; i++)
					{
					    k = keys[i];
						options += '<option value="' + this[k].Filename + '" data-desc="' + this[k].Desc + '" data-type="' + this[k].Type + '">' + k + '</option>';
					}
					
					// Optionsgroup aanmaken en daarin options laden
			        $('#select_variable').append('<optgroup label="' + index + '">' + options + '</optgroup>');
			    });
			});
			
			// loadData functie om de JSONs in te laden en in een variabele te zetten
			function loadData(variable) {
				if (variable == '') {
					return false;
				}
				return (function () {
				    var json = null;
				    $.ajax({
				        'async': false,
				        'global': false,
				        'url': variable,
				        'dataType': "json"
				    }).done(function(data) {
				    	json = data;
				    });
				    return json;
				})();
			}
			
			// Variabelen initaliseren
			var selected_variable = $('#select_variable').val();
			var selected_type = $('#select_variable').find(":selected").data('type');
			var eenheid = '';
			if (selected_type == "%") {
				eenheid = '%';
			}
			var cbs_data = '';
			
			// Hoogte, breedte, tooltip, actieve gemeente en provincie van de kaart initialiseren
			var height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) * 0.88,
			    width = height * 0.85,
			    active_prov = d3.select(null),
			    active_gem = d3.select(null),
			    tooltip;
			    
			// Lege tooltip aanmaken
	    	tooltip = d3.select('#wrapper') 
	    		.append('div')                 
	    		.attr('class', 'tooltip')
	    	
	    	tooltip.append('div')            
	    		.attr('class', 'label');
			
			// Kaartspecifieke variabelen initaliseren
			var projection = d3.geo.mercator()
			    .scale(height * 11)
			    .translate([width / 2, height / 2])
			    .center([5.4, 52.2]);
						
			var path = d3.geo.path()
			    .projection(projection);
			
			// Zoombehaviour initialiseren
		    var zoom = d3.behavior.zoom()
		        .translate([0, 0])
		        .scale(1)
		        .scaleExtent([1, 8])
		        .on("zoom", zoomed);
		    
		    // Snelheid van zoombeweging
		    var zoom_speed = 400;
			var zoom_counter = 0;   
			
			// Zet SVG in div #map
			var svg = d3.select("#map").append("svg")
			    .attr("width", width)
			    .attr("height", height)
				.on("click", stopped, true); // TODO: wat doet dit?
			
			// Voeg een rectangle toe aan de SVG waar alle gemeentes in komen
			svg.append("rect")
			    .attr("class", "background")
			    .attr("width", width)
			    .attr("height", height)
			    .on("click", reset_to_land);
			
			// Initialiseren provinces en gemeentes
			var g = svg.append('g'), // Provincies
				gg = svg.append('g'), // Gemeentes
				selected_provincie = null,
				selected_provincie_obj,
				selected_gemeente = null,
				selected_gemeente_obj;
			
			// Globale variabele met kleurschaal (kleurenpalet)
            var colorScale = d3.scale.quantize();
            
            var provincies_gemcode = loadData('gemeente-prov/provincies.json');
            
            var provincies = {"Groningen": 20, "Friesland": 21, "Drenthe": 22,
                         "Overijssel": 23, "Flevoland": 24, "Gelderland": 25,
                         "Utrecht": 26, "Noord-Holland": 27, "Zuid-Holland": 28,
                         "Zeeland": 29, "Noord-Brabant": 30, "Limburg": 31};
            
            var provincies_reverse = {"20": "Groningen", "21": "Friesland", "22": "Drenthe",
                         "23": "Overijssel", "24": "Flevoland", "25": "Gelderland",
                         "26": "Utrecht", "27": "Noord-Holland", "28": "Zuid-Holland",
                         "29": "Zeeland", "30": "Noord-Brabant", "31": "Limburg"};
            
            var provincies_data = {"Groningen": null, "Friesland": null, "Drenthe": null,
                         "Overijssel": null, "Flevoland": null, "Gelderland": null,
                         "Utrecht": null, "Noord-Holland": null, "Zuid-Holland": null,
                         "Zeeland": null, "Noord-Brabant": null, "Limburg": null};
            
            // Inladen provincies
            d3.json("build/prov.json", function(error, prov) {
            	if (error) return console.error(error);
            	data_feature = topojson.feature(prov, prov.objects.provgeo).features;
            	
            	// Specificeren hoe de provincies eruit komen te zien, hoogte, breedte, kleur, tooltips
            	g.attr("class", "provincies")
            		.selectAll("path")
            		.data(data_feature)
            		.enter().append("g")
            		.attr("class", "provincie")
            		.append("path")
            		.attr("id", function(d) { provincies_data[d.properties.PROV_NAME] = d; return d.properties.PROV_NAME })
            		.attr("d", path)
            		.attr("fill", "#ccc")
            		.on('mouseover', function(d) {
            			tooltip.select('.label').html(d.properties.PROV_NAME);
            			tooltip.style('display', 'block');
            		})
            		.on('mouseout', function(d) {
            			tooltip.style('display', 'none');
            		})
            		.on('mousemove', function(d) {
            			tooltip.style('top', (d3.event.pageY + 10) + 'px')
            		    	.style('left', (d3.event.pageX + 10) + 'px');
            		});
            		
            });
            
            
            svg.call(zoom.event);
            var i= 0;
            
            // Slider voor onder aan de kaart
            // Jaren die van toepassing zijn voor de kaart
            var yearRange = [2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014];
            var yearMin = yearRange[0];
            var yearMax = yearRange[yearRange.length - 1];
            var slider_value = yearMax; // Huidige jaar, wordt aangepast als slider verandert
            d3.select('#slider')
            	.style("width", width + "px")
            	.call(d3.slider()
	            	.scale(d3.scale.ordinal()
	            		.domain(yearRange).rangePoints([0, 1], 0.5))
	            	.axis(d3.svg.axis())
	            	.snap(true)
	            	.value(yearMax)
	            	.on("slide", function(evt, value){
	            		slider_value = value;
	            		redraw();
	            	})
	            );
	            
			// Standaard de gegevensbron select selecteren
            $("#select_variable").focus();
			
			// Als een andere gegevensbron wordt gekozen, kaart aanpassen
			$('#select_variable').change(function() {
				
				// Huidige gegevensbron veranderen
				selected_variable = $(this).val();
				selected_type = $('#select_variable').find(":selected").data('type');
				
				// Eenheid aanpassen op basis van gekozen gegevensbron
				if (selected_type == "%") {
					eenheid = '%';
				}
				else {
					eenheid = '';
				}
				
				// Global variabele cbs_data opvullen met een JSON object
				cbs_data = loadData('convert/data/json/' + selected_variable);
				
				// Omschrijving van gegevensbron aanpassen
				$('#description').html($('option:selected', this).data('desc'));
				
                // Teken alle gemeentes
                // Eerst alle huidige gemeentes weg
                gg.selectAll('path').remove();
                
                var countrydata = cbs_data[slider_value]['__countrydata'];
                console.log(countrydata);
                
                $('#minmaxavg').remove();
                var html = '<div id="minmaxavg"><p><strong>Gemiddelde:</strong> ' + countrydata.avg.toFixed(1) + '</p>' +
                    '<p><strong>Min:</strong> ' + toTitleCase(countrydata.min[1]) + ', ' + countrydata.min[2].toFixed(1) + '</p>' +
                    '<p><strong>Max:</strong> ' + toTitleCase(countrydata.max[1]) + ', ' + countrydata.max[2].toFixed(1) + '</p></div>';
                $('#description').append(html);

            	var land_gem_data = loadData('gemeente-prov/topo_' + slider_value + '_cords.json');
            	
            	var dataset = {};
            	$.each(provincies, function (i, v) {
            		$.each(cbs_data[slider_value][i], function (j, w) {
                		// Als deze variabelen, dan delen door 100
                		if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
                			// TODO: delen door 100?
                			dataset[j] = w;
                		}
                		else {
                			dataset[j] = w;
            			}
            		});
            	});
            	
            	provdata = cbs_data[slider_value]['__countrydata'];
            	
            	var min = provdata.min[2];
            	var max = provdata.max[2];
            	
            	// Kleurschaal instellen met als range de min en max van de data
            	colorScale
            		    .range(colorbrewer.OrRd[8])
            		    .domain([min, max]);
            	
            	var coords = topojson.feature(land_gem_data, land_gem_data.objects['latlon_'+slider_value+'_cords']).features;
            	
            	// Gemeentes instellen, kleur, grootte, tooltip, click event, etc
            	// TODO: mouseover provincie border!!
            	gg.selectAll('path')
            		.data(coords)
            		.enter().append("g")
            		.attr("class", "gemeente")
            		.attr("id", function(d) { return d.properties.statnaam; })
            		.append("path")
            		.on("click", function (d) {
                		var current_provincie;
                		$.each(provincies_gemcode[slider_value], function(i, v) { //Jaar
                			if (v.indexOf(d.properties.statcode) != -1) {
                				current_provincie = i;
                			}
                		});
                		
            			zoom_prov(provincies_data[provincies_reverse[current_provincie]], d); 
            		})
            		.on('mouseover', function(d) {
            			// Tooltips! Als bepaalde variabelen, dan delen door 100 omdat D3 decimale getallen niet leuk vindt
            			if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
            				var value = dataset[d.properties.statnaam] / 100;
            			}
            			else {
            				var value = dataset[d.properties.statnaam];
            			}
            			// Tooltip opvullen met gemeentenaam, waarde (geformat naar NL cijfers) met eenheid (% bijv)
            			tooltip.select('.label').html(toTitleCase(d.properties.statnaam) + "<br />" + parseFloat(value).toLocaleString('nl') + eenheid);
            			tooltip.style('display', 'block');
            		})
            		.on('mouseout', function(d) {
            			tooltip.style('display', 'none');
            		})
            		.on('mousemove', function(d) {
            			tooltip.style('top', (d3.event.pageY + 10) + 'px')
            		    	.style('left', (d3.event.pageX + 10) + 'px');
            		})
            		.attr("id", function(d) { return d.properties.statnaam })
            		.attr("d", path)
            		.attr("fill", function(d) {
            			if (dataset[d.properties.statnaam] === undefined) {
            				return '#ccc';
            			}
            			return colorScale(dataset[d.properties.statnaam]);
            		});
            		
        			if (selected_provincie != null) {
        		        // Legenda aanmaken
        		        legend();
        		        
        		        // Als gemeente geselecteerd, creëer chart
        				if (selected_gemeente != null) {
        					drawChart();
        				}
        				else {
        					// Anders treemap
        					drawTreemap();
        				}
        		    }
            		
                    legend();
                    svg.selectAll('g.provincies').remove();
				
			});
			
			// Functie redraw, aangeroepen door een verandering in de slider
			// Eigenlijk gebeurt hier hetzelfde als bij het veranderen van gegevensbron: 
			// inladen gemeentes en attributen instellen zoals hoogte en breedte, etc
			function redraw() {
				if (selected_variable.length) {
					cbs_data = loadData('convert/data/json/' + selected_variable);
					
					if (selected_provincie != null) {
						
                        legend();
						
						if (selected_gemeente != null) {
							drawChart();
						}
						else {
							drawTreemap();
						}
					}
					
					// Teken alle gemeentes
					// Eerst alle huidige gemeentes weg
					gg.selectAll('path').remove();
					
					var countrydata = cbs_data[slider_value]['__countrydata'];
					
					$('#description').html($('option:selected', this).data('desc'));
                    $('#minmaxavg').remove();
                    var html = '<div id="minmaxavg"><p><strong>Gemiddelde:</strong> ' + countrydata.avg.toFixed(1) + '</p>' +
                        '<p><strong>Min:</strong> ' + toTitleCase(countrydata.min[1]) + ', ' + countrydata.min[2].toFixed(1) + '</p>' +
                        '<p><strong>Max:</strong> ' + toTitleCase(countrydata.max[1]) + ', ' + countrydata.max[2].toFixed(1) + '</p></div>';
                    $('#description').append(html);
					
                	var land_gem_data = loadData('gemeente-prov/topo_' + slider_value + '_cords.json');
                	
                	var dataset = {};
                	$.each(provincies, function (i, v) {
                		$.each(cbs_data[slider_value][i], function (j, w) {
	                		// Als deze variabelen, dan delen door 100
	                		if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
	                			// TODO: delen door 100?
	                			dataset[j] = w;
	                		}
	                		else {
	                			dataset[j] = w;
                			}
                		});
                	});
                	
                	provdata = cbs_data[slider_value]['__countrydata'];
                	
                	var min = provdata.min[2];
                	var max = provdata.max[2];
                	
                	// Kleurschaal instellen met als range de min en max van de data
                	colorScale
                		    .range(colorbrewer.OrRd[8])
                		    .domain([min, max]);
                	
                	var coords = topojson.feature(land_gem_data, land_gem_data.objects['latlon_'+slider_value+'_cords']).features;
                	
                	// Gemeentes instellen, kleur, grootte, tooltip, click event, etc
                	// TODO: mouseover provincie border!!
                	gg.selectAll('path')
                		.data(coords)
                		.enter().append("g")
                		.attr("class", "gemeente")
                		.attr("id", function(d) { return d.properties.statnaam; })
                		.append("path")
                		.on("click", function (d) {
	                		var current_provincie;
	                		$.each(provincies_gemcode[slider_value], function(i, v) { //Jaar
                		    	if (v.indexOf(d.properties.statcode) != -1) {
                		    		current_provincie = i;
                		    	}
	                		});
	                	
                			zoom_prov(provincies_data[provincies_reverse[current_provincie]], d); 
                		})
                		.attr("id", function(d) { return d.properties.name })
                		.attr("d", path)
                		.attr("fill", function(d) {
                			if (dataset[d.properties.statnaam] === undefined) {
                				return '#ccc';
                			}
                			return colorScale(dataset[d.properties.statnaam]);
                		});
					
				}
			}
			
			// Deze functie wordt aangeroepen als er op een gemeente wordt geklikt
			// Aan de SVG wordt doorgegeven welke x en y punten er als hoeken gekozen moeten worden (zie bounds)
			// Tevens instellen variabelen welke gemeente geselecteerd is
			function zoom_gem(d) {
				if (selected_variable == '') { alert('Selecteer eerst een gegevensbron'); return false; }
				if (active_gem.node() === this) { $('#gemeente').html(''); return reset_to_prov(); }
				zoom_counter = 2;
				selected_gemeente = d;
				selected_gemeente_obj = this;
				
				$('#gemeente').html("&raquo; " + toTitleCase(d.properties.statnaam));
				
				var bounds = path.bounds(d),
					dx = bounds[1][0] - bounds[0][0],
					dy = bounds[1][1] - bounds[0][1],
					x = (bounds[0][0] + bounds[1][0]) / 2,
					y = (bounds[0][1] + bounds[1][1]) / 2,
					scale = 0.9 / Math.max(dx / width, dy / height),
					translate = [width / 2 - scale * x, height / 2 - scale * y];
				
				svg.transition()
					.duration(zoom_speed)
					.call(zoom.translate(translate).scale(scale).event);
				
				//$('#slider').hide();
				drawChart();
                legend()
				
			}
			
			// Aanmaken dataset voor de lijngrafiek en staafgrafiek
			function genDataset() {
				var dataset = [];
				
				$.each(yearRange, function (i, v) {
                    var obj = {'year': v}
                    obj[selected_variable] = cbs_data[v][selected_provincie.properties.PROV_NAME][selected_gemeente.properties.statnaam];
					dataset.push(obj); 
				});
				
				return dataset;
			}
			
            var second_data = [];
            var second_variable= '';
			// Deze functie wordt aangeroepen als er ingezoomd wordt op een gemeente
			// Radioboxes voor kiezen lijn/staaf aanmaken, aanroepen draw-functies 
			function drawChart() {
				$('#visual').empty();
				
				$('#visual').append('<form>' + 
									'<label><input type="radio" name="mode" value="line" checked="checked"> Lijn</label>' +
									'<label><input type="radio" name="mode" value="bar"> Staaf</label>' +
									'</form>');

                $('#visual').append('<label>Kies hier een tweede variabele om te vergelijken: </label><select id="second_variable" name="Tweede Variabele">' +
                        '<option>Selecteer Variable</option>' +
                        '</select>');
                $.ajax({
                    'async': false,
                    'global': false,
                    'url': 'convert/data/json/expl.json',
                    'dataType': "json"
                }).done(function(data) {
                    // Groepen inladen
                    $.each(data, function(index) {
                        var options = '';
                        
                        keys = Object.keys(this),
                        i, len = keys.length;
                        
                        // Alfabetische volgorde van gegevensbronnen
                        keys.sort();
                        
                        // Options aanmaken
                        for (i = 0; i < len; i++)
                        {
                            k = keys[i];
                            if( this[k].Type === selected_type) {
                                options += '<option value="' + this[k].Filename + '" data-desc="' + this[k].Desc + '" data-type="' + this[k].Type + '">' + k + '</option>';
                            }
                        }
                        
                        // Optionsgroup aanmaken en daarin options laden
                        $('#second_variable').append('<optgroup label="' + index + '">' + options + '</optgroup>');
                    });
                });
                $('#second_variable').change(function () {
                    second_data = [];
                    second_variable = $(this).val();
                    var data = loadData('convert/data/json/' + second_variable);
                    $.each(yearRange, function (i, v) {
                        var obj = {'year': v};
                        obj[second_variable] = data[v][selected_provincie.properties.PROV_NAME][selected_gemeente.properties.statnaam];
                        second_data.push(obj);
                    });
                    drawLineChart();
                });
				if ($("input[type=radio]").val() == "line") {
					$('#visual svg').remove();
					drawLineChart();
				}
				else if ($("input[type=radio]").val() == "bar") {
					$('#visual svg').remove();
					drawBarChart();
				}
				
				$("input[type=radio]").change(function() {
					if ($(this).val() == "line") {
						$('#visual svg').remove();
						drawLineChart();
					}
					else if ($(this).val() == "bar") {
						$('#visual svg').remove();
						drawBarChart();
					}
				});
				
            }
			

			// Deze functie wordt aangeroepen om een linechart te bouwen
			// Instellen x en y-as, zie variabelenamen voor hun taak
			function drawLineChart() {
                $('#visual svg').remove();
                var dataset = genDataset();
                if (second_data.length > 0) {
                    $.each(dataset, function (i, e){
                        dataset[i][second_variable] = +second_data[i][second_variable];
                    });
                }

				var margin = {top: 20, right: 20, bottom: 30, left: 60},
				    width = $(".right").width() * 0.8,
				    height = width * 0.6;
				
				var x = d3.scale.ordinal()
				    .rangeRoundBands([0, width], .3);
				
				var y = d3.scale.linear()
				    .range([height, 0]);
				
				var xAxis = d3.svg.axis()
				    .scale(x)
				    .orient("bottom");
				    
				var yAxis = d3.svg.axis()
				    .scale(y)
				    .orient("left")
				    .tickFormat(function(d) { return parseFloat(d).toLocaleString('nl'); });
				
				// Als deze variabelen, dan delen door 100
				if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
					yAxis.tickFormat(function(d) { return parseFloat(d / 100).toLocaleString('nl'); });
				}
				
				var svg = d3.select("#visual").append("svg")
				    .attr("width", width + margin.left + margin.right)
				    .attr("height", height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				    
                
                var min = [],
                    max = [];

                $.each(dataset, function (i, v){
                    min.push(Math.floor(dataset[i][selected_variable] * 0.9));
                    max.push(Math.ceil(dataset[i][selected_variable] * 1.1));
                    if (second_variable) {
                        min.push(Math.floor(dataset[i][second_variable] * 0.9));
                        max.push(Math.ceil(dataset[i][second_variable] * 1.1));
                    }
                });

				min = d3.min(min);
			    max = d3.max(max);
					
                y.domain([min, max]);
                x.domain(yearRange);

                if (second_data.length > 0) {

                    var line = d3.svg.line()
                        .defined(function (d) { return d[selected_variable]; })
                        .x(function(d) { return x(d.year); })
                        .y(function(d) { return y(d[selected_variable]); });

                    var second_line = d3.svg.line()
                        .defined(function (d) { return d[second_variable]; })
                        .x(function(d) { return x(d.year); })
                        .y(function(d) { return y(d[second_variable]); });
                }
			    else{	
                    var line = d3.svg.line()
                        .defined(function (d) { return d[selected_variable]; })
                        .x(function(d) { return x(d.year); })
                        .y(function(d) { return y(d[selected_variable]); });
                }
				// Toevoegen x-as
				svg.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + height + ")")
					.call(xAxis);
				
				// Toevoegen y-as
				svg.append("g")
					.attr("class", "y axis")
					.call(yAxis)
					.append("text")	
					.attr("y", 6)
					.attr("dy", ".71em")
					.style("text-anchor", "end")
					.text($('#select_variable').find(":selected").data('type'));
				
				// Lijn tekenen
				svg.append("path")
					.datum(dataset)
					.attr("class", "line")
					.attr("d", line);

                if (second_data) {
                    svg.append("path")
                        .datum(dataset)
                        .attr("class", "line2")
                        .attr("d", second_line);
                }
                
                var legend = svg.append("g")
                    .attr('class', 'legend')
                    .selectAll('g.legendEntry')
                    .data(function () {if (second_variable){ return ['steelblue', 'red'];} return ['steelblue'];})
                    .enter()
                    .append('g').attr('class', 'legendEntry');

                legend.append('rect')
                    .attr("x", width - 100)
                    .attr("y", function(d,i){
                        return (i * 20) + 5;})
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("stroke", "black")
                    .style("stroke-width", 1)
                    .style("fill", function (d) { return d; });

                legend.append('text')
                    .attr("x", 20)
                    .attr("y", function (d, i) {
                        return (i * 20) + 5;})
                    .attr("dy", "0.8em")
                    .text(function (d, i) {
                        console.log(d,i)
                    })
                second_variable = '';
			}
			
			// Deze functie wordt aangeroepen om een barchart te bouwen
			// Instellen x en y-as, zie variabelenamen voor hun taak
			function drawBarChart() {
				
				var dataset = genDataset();
				
				var margin = {top: 20, right: 20, bottom: 30, left: 60},
				    width = $(".right").width() * 0.8,
				    height = width * 0.6;
				
				var x = d3.scale.ordinal()
				    .rangeRoundBands([0, width], .3);
				
				var y = d3.scale.linear()
				    .range([height, 0]);
				
				var xAxis = d3.svg.axis()
				    .scale(x)
				    .orient("bottom");
				    
				var yAxis = d3.svg.axis()
				    .scale(y)
				    .orient("left")
				    .tickFormat(function(d) { return parseFloat(d).toLocaleString('nl'); });
				    
			    if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
			    	yAxis.tickFormat(function(d) { return parseFloat(d / 100).toLocaleString('nl'); });
			    }
				
				var svg = d3.select("#visual").append("svg")
				    .attr("width", width + margin.left + margin.right)
				    .attr("height", height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				
				x.domain([2006,2007,2008,2009,2010,2011,2012,2013,2014]);
				y.domain([0, d3.max(dataset, function(d) { return Math.ceil(d[selected_variable] * 1.1); })]);
				
				// Toevoegen x-as
				svg.append("g")
				  .attr("class", "x axis")
				  .attr("transform", "translate(0," + height + ")")
				  .call(xAxis);
				
				// Toevoegen y-as
				svg.append("g")
				  .attr("class", "y axis")
				  .call(yAxis)
				.append("text")
				  .attr("transform", "rotate(-90)")
				  .attr("y", 6)
				  .attr("dy", ".71em")
				  .style("text-anchor", "end")
				  .text($('#select_variable').find(":selected").data('type'));
				
				// Bars aanmaken
				svg.selectAll(".bar")
				  .data(dataset)
				  .enter()
				  .append("rect")
				  .attr("class", "bar")
				  .attr("x", function(d) { return x(d.year); })
				  .attr("width", x.rangeBand())
				  .attr("y", function(d) { return y(d[selected_variable]); })
				  .attr("height", function(d) { return height - y(d[selected_variable]); });
			
			}
			
			// Deze functie wordt aangeroepen om een treemap te bouwen op provincieniveau
			// Kies de juiste kinderen uit de volledige dataset (bijv provincie), reverse stedelijkheid, zie variabelenamen voor hun taak
			function drawTreemap() {
			
				$('#visual').empty();
				
				var margin = {top: 10, right: 0, bottom: 5, left: 0},
				    width = $(".right").width() * 0.95,
				    height = width * 0.7;
			
				var treemap = d3.layout.treemap()
				    .size([width, height])
				    .sticky(true);
				    
				if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
					treemap.value(function(d) { return d.value / 100; });
				}
				else if (selected_variable == 'stedelijkheid.json') {
					treemap.value(function(d) { return 6 - d.value; });
				}
				else {
				    treemap.value(function(d) { return d.value; });
				}
				
				var color = d3.scale.category20();
				
				var div = d3.select("#visual").append("div")
				    .style("position", "relative")
				    .style("width", (width + margin.left + margin.right) + "px")
				    .style("height", (height + margin.top + margin.bottom) + "px")
				    .style("left", margin.left + "px")
				    .style("top", margin.top + "px");
				
				d3.json("convert/data/json/tree_" + selected_variable, function(error, root) {
					if (error) throw error;
					
					var dataset;
					$.each(root.children, function(i, v) {
					    if (v.name == slider_value) {
					    	if (selected_provincie == null) {
					    		dataset = v;
					    		return;
					    	}
					    	else {
						        $.each(v.children, function(i, v) {
						            if (v.name == selected_provincie.properties.PROV_NAME) {
						                dataset = v;
						                return;
						            }
						        });
							}
					    }
					});
					
					var node = div.datum(dataset).selectAll(".node")
						.data(treemap.nodes)
						.enter()
						.append("div")
						.attr("class", "node")
						.call(position)
						.style("background", function(d) { return color(d.name); })
                        .append("span")
                            .html(function(d) { return toTitleCase(d.name) + "<br>" + d.value;});
						
				});
				
			}
			
			// Functie voor treemap positionering
			function position() {
				this.style("left", function(d) { return d.x + "px"; })
			      .style("top", function(d) { return d.y + "px"; })
			      .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
			      .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
			}
			
			// Zoom naar provincie, aangeroepen door click event provincie
			// Spreekt redelijk voor zich
			function zoom_prov(d, d2) {
			
				if (selected_variable == '') { alert('Selecteer eerst een gegevensbron'); return false; }
				
				if (zoom_counter == 1) {
				
					var current_provincie;
					$.each(provincies_gemcode[slider_value], function(i, v) { //Jaar
					    $.each(v, function(j, w) { // Provincie
					    	if (v.indexOf(d2.properties.statcode) != -1) {
					    		current_provincie = i;
					    		
					    	}
					    });
					});
					
					var next_provincie = provincies_data[provincies_reverse[current_provincie]];
					if (selected_provincie == next_provincie) {
						zoom_gem(d2);
						return true;
					}
				}

				selected_gemeente = null;
				selected_gemeente_obj = null;
				$('#gemeente').html('');
				
				drawTreemap();
				selected_provincie = d;
				selected_provincie_obj = this;
				
				$('#provincie').html("&raquo; " + d.properties.PROV_NAME);
				
				zoom_counter = 1;
				
				// Inzoomen
				var bounds = path.bounds(d),
					dx = bounds[1][0] - bounds[0][0],
					dy = bounds[1][1] - bounds[0][1],
					x = (bounds[0][0] + bounds[1][0]) / 2,
					y = (bounds[0][1] + bounds[1][1]) / 2,
					scale = 0.9 / Math.max(dx / width, dy / height),
					translate = [width / 2 - scale * x, height / 2 - scale * y];
				
				svg.transition()
					.duration(zoom_speed)
					.call(zoom.translate(translate).scale(scale).event);
				
			}
			
			// Uitzoomen: gemeente -> prov
			function reset_to_prov() {
				zoom_counter = 1;
				//$('#slider').show();
				$('#visual').empty();
				drawTreemap();
				
				active_gem.classed("active_gem", false);
				active_gem = d3.select(null);
				selected_gemeente = null;
				active_prov.classed("active_prov", false);
				active_prov = d3.select(selected_provincie_obj).classed("active_prov", true);
				
				var bounds = path.bounds(selected_provincie),
					dx = bounds[1][0] - bounds[0][0],
					dy = bounds[1][1] - bounds[0][1],
					x = (bounds[0][0] + bounds[1][0]) / 2,
					y = (bounds[0][1] + bounds[1][1]) / 2,
					scale = 0.9 / Math.max(dx / width, dy / height),
					translate = [width / 2 - scale * x, height / 2 - scale * y];
				
				svg.transition()
					.duration(zoom_speed)
					.call(zoom.translate(translate).scale(scale).event);
				
			}
			
			// Uitzoomen: gemeente/provincie -> land
			function reset_to_land() {
				zoom_counter = 0;
				
				//$('#slider').show();
				$('#visual').empty();
				
				selected_provincie = null;
				selected_gemeente = null;
				$('#provincie').html('');
				$('#gemeente').html('');
				
				active_gem.classed("active_gem", false);
				active_gem = d3.select(null);
				active_prov.classed("active_prov", false);
				active_prov = d3.select(null);
				
				svg.transition()
				  .duration(zoom_speed)
				  .call(zoom.translate([0, 0]).scale(1).event);

			    remove_legend();	
			}
			
			// D3 zoom event
			function zoomed() {
				g.style("stroke-width", 1.5 / d3.event.scale + "px");
				g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
				gg.style("stroke-width", 1.5 / d3.event.scale + "px");
				gg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
				
			}
			
			// D3 supporting zoom
			function stopped() {
				if (d3.event.defaultPrevented) d3.event.stopPropagation();
			}
			
			// Gemeentenamen titlecase'n
			function toTitleCase(str)
			{
			    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
			}

            // Legenda bouwen
            function legend(){
                remove_legend();

                var legend = svg.append('g')
                    .attr('class', 'legend')
                    .selectAll('g.legendEntry')
                    .data(colorScale.range())
                    .enter()
                    .append('g').attr('class', 'legendEntry');

                legend.append('rect')
                    .attr("x", 5)
                    .attr("y", function(d, i) {
                               return (i * 20) + 5;
                                   })
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("stroke", "black")
                    .style("stroke-width", 1)
                    .style("fill", function(d){return d;}); 
                  //the data objects are the fill colors

                legend.append('text')
                    .attr("x", 20) //leave 5 pixel space after the 
                    .attr("y", function(d, i) {
                                return (i * 20) + 5;
                            })
                    .attr("dy", "0.8em") //place text one line *below* the x,y point
                    .text(function(d,i) {
                        var extent = colorScale.invertExtent(d);
                        //extent will be a two-element array, format it however you want:
                        var format = d3.format("1f");
                        return format(+extent[0]) + " - " + format(+extent[1]) + ' ' + selected_type;
                    });
            }
			
			// Legenda verwijderen
            function remove_legend(){
                svg.selectAll('g.legend').remove();
            }
			
		});
        </script>
	</body>
</html>
