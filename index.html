<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>D3 Project</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js"></script>
		<script src="node_modules/topojson/topojson.min.js"></script>
		<script src="js/colorbrewer.js"></script>
		<link rel="stylesheet" href="css/main.css" />
		<script src="js/d3.slider.js" type="text/javascript"></script>
		<link rel="stylesheet" href="css/d3.slider.css" />
        <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
	</head>
	
	<body>
		<div id="wrapper">
			<div class="column left">
				<div id="map">
					<div id="instructieBox">
						 Selecteer een gegevensbron en klik op de gewenste provincie. Met de slider onder de kaart wordt de data van het gewenste jaar weergeven. Klik daarna op een gemeente om meer informatie over een gemeente te zien over de tijd. Op gemeenteniveau kunnen ook twee gegevensbronnen tegen elkaar af worden gezet.
					</div>
					<div id="legend">
					</div>
				</div>
	
				<div id="slider"></div>
			</div>
			
			<div class="column right">
			
				<div id="properties">
					<p>
						<select id="select_variable" name="select_variable">
							<option value="">Selecteer gegevensbron</option>
						</select>
					</p>
                    <p id="description"></p>
                    <p id="breadcrumb">Nederland
                        <span id="provincie"></span>
                        <span id="gemeente"></span></p>
                    <div id="minmaxavg">
                    </div>
				</div>
				
				<div id="visual">
					
					
				</div>
			
			</div>
		</div>
		
		<script type="text/javascript">
		$(document).ready(function() {
			

            var expl = {};
            var provincie_gemcode = null;
			// Inladen gegevensbronnen in de select
			$.ajax({
			    'async': false,
			    'global': false,
			    'url': 'convert/data/json/expl.json',
			    'dataType': "json"
			}).done(function(data) {
				// Groepen inladen
				$.each(data, function(index) {
					var options = '';
					
				    keys = Object.keys(this),
				    i, len = keys.length;
					
					// Alfabetische volgorde van gegevensbronnen
					keys.sort();
					
					// Options aanmaken
					for (i = 0; i < len; i++)
					{
					    k = keys[i];
						options += '<option value="' + this[k].Filename + '" data-desc="' + this[k].Desc + '" data-type="' + this[k].Type + '">' + k + '</option>';
                        expl[this[k].Filename] = k;
					}
					
					// Optionsgroup aanmaken en daarin options laden
			        $('#select_variable').append('<optgroup label="' + index + '">' + options + '</optgroup>');
			    });
			});
			
			// loadData functie om de JSONs in te laden en in een variabele te zetten
			function loadData(variable) {
				if (variable == '') {
					return false;
				}
				return (function () {
				    var json = null;
				    $.ajax({
				        'async': false,
				        'global': false,
				        'url': variable,
				        'dataType': "json"
				    }).done(function(data) {
				    	json = data;
				    });
				    return json;
				})();
			}
			
			// Variabelen initaliseren
			var selected_variable = $('#select_variable').val();
			var selected_type = $('#select_variable').find(":selected").data('type');
			var eenheid = '';
			if (selected_type == "%") {
				eenheid = '%';
			}
			var cbs_data = '';
			
			// Hoogte, breedte, tooltip, actieve gemeente en provincie van de kaart initialiseren
			var height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0) * 0.88,
			    width = height * 0.85,
			    active_prov = d3.select(null),
			    active_gem = d3.select(null),
			    tooltip;
			    
			$('#instructieBox').css('width', width - 20);
			$('#instructieBox').css('height', height - 20);
			    
			// Lege tooltip aanmaken
	    	tooltip = d3.select('#wrapper') 
	    		.append('div')                 
	    		.attr('class', 'tooltip')
	    	
	    	tooltip.append('div')            
	    		.attr('class', 'label');
			
			// Kaartspecifieke variabelen initaliseren
			var projection = d3.geo.mercator()
			    .scale(height * 11)
			    .translate([width / 2, height / 2])
			    .center([5.4, 52.2]);
						
			var path = d3.geo.path()
			    .projection(projection);
			
			// Zoombehaviour initialiseren
		    var zoom = d3.behavior.zoom()
		        .translate([0, 0])
		        .scale(1)
		        .scaleExtent([1, 8])
		        .on("zoom", zoomed);
		    
		    // Snelheid van zoombeweging
		    var zoom_speed = 400;
			var zoom_counter = 0;   
			
			// Zet SVG in div #map
			var svg = d3.select("#map").append("svg")
			    .attr("width", width)
			    .attr("height", height)
			    .style('background-color', '#ECF3FD')
				.on("click", stopped, true);
			
			// Voeg een rectangle toe aan de SVG waar alle gemeentes in komen
			svg.append("rect")
			    .attr("class", "background")
			    .attr("width", width)
			    .attr("height", height)
			    .on("click", reset_to_land);
			
			// Initialiseren provinces en gemeentes
			var g = svg.append('g'), // Provincies
				gg = svg.append('g'), // Gemeentes
				selected_provincie = null,
				selected_provincie_obj,
				selected_gemeente = null,
				selected_gemeente_obj;
			
			// Globale variabele met kleurschaal (kleurenpalet)
            var colorScale = d3.scale.quantize();
            
            provincies_gemcode = loadData('gemeente-prov/provincies.json');
            
            var provincies = {"Groningen": 20, "Friesland": 21, "Drenthe": 22,
                         "Overijssel": 23, "Flevoland": 24, "Gelderland": 25,
                         "Utrecht": 26, "Noord-Holland": 27, "Zuid-Holland": 28,
                         "Zeeland": 29, "Noord-Brabant": 30, "Limburg": 31};
            
            var provincies_reverse = {"20": "Groningen", "21": "Friesland", "22": "Drenthe",
                         "23": "Overijssel", "24": "Flevoland", "25": "Gelderland",
                         "26": "Utrecht", "27": "Noord-Holland", "28": "Zuid-Holland",
                         "29": "Zeeland", "30": "Noord-Brabant", "31": "Limburg"};
            
            var provincies_data = {"Groningen": null, "Friesland": null, "Drenthe": null,
                         "Overijssel": null, "Flevoland": null, "Gelderland": null,
                         "Utrecht": null, "Noord-Holland": null, "Zuid-Holland": null,
                         "Zeeland": null, "Noord-Brabant": null, "Limburg": null};
            
            // Inladen provincies
            d3.json("build/prov.json", function(error, prov) {
            	if (error) return console.error(error);
            	data_feature = topojson.feature(prov, prov.objects.provgeo).features;
            	
            	// Specificeren hoe de provincies eruit komen te zien, hoogte, breedte, kleur, tooltips
            	g.attr("class", "provincies")
            		.selectAll("path")
            		.data(data_feature)
            		.enter().append("g")
            		.attr("class", "provincie")
            		.append("path")
            		.attr("id", function(d) { provincies_data[d.properties.PROV_NAME] = d; return d.properties.PROV_NAME })
            		.attr("d", path)
            		.attr("fill", "#ccc")
            		.on('click', function() { alert('Selecteer eerst een gegevensbron.'); })
            		.on('mouseover', function(d) {
            			tooltip.select('.label').html(d.properties.PROV_NAME);
            			tooltip.style('display', 'block');
            		})
            		.on('mouseout', function(d) {
            			tooltip.style('display', 'none');
            		})
            		.on('mousemove', function(d) {
            			tooltip.style('top', (d3.event.pageY + 10) + 'px')
            		    	.style('left', (d3.event.pageX + 10) + 'px');
            		});
            		
            });
            
            
            svg.call(zoom.event);
            var i= 0;
            
            // Slider voor onder aan de kaart
            // Jaren die van toepassing zijn voor de kaart
            var yearRange = [2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014];
            var yearMin = yearRange[0];
            var yearMax = yearRange[yearRange.length - 1];
            var slider_value = yearMax; // Huidige jaar, wordt aangepast als slider verandert
            d3.select('#slider')
            	.style("width", width + "px")
            	.call(d3.slider()
	            	.scale(d3.scale.ordinal()
	            		.domain(yearRange).rangePoints([0, 1], 0.5))
	            	.axis(d3.svg.axis())
	            	.snap(true)
	            	.value(yearMax)
	            	.on("slide", function(evt, value){
	            		slider_value = value;
	            		redraw();
	            	})
	            );
	            
			// Standaard de gegevensbron select selecteren
            $("#select_variable").focus();
			
			// Als een andere gegevensbron wordt gekozen, kaart aanpassen
			$('#select_variable').change(function() {
				$('#instructieBox').hide();
				if ($(this).val() == '') {
					$('#instructieBox').show();
				}
				
				// Huidige gegevensbron veranderen
				selected_variable = $(this).val();
				selected_type = $('#select_variable').find(":selected").data('type');
				
				// Eenheid aanpassen op basis van gekozen gegevensbron
				if (selected_type == "%") {
					eenheid = '%';
				}
				else {
					eenheid = '';
				}
				
				// Global variabele cbs_data opvullen met een JSON object
				cbs_data = loadData('convert/data/json/' + selected_variable);
				
				// Omschrijving van gegevensbron aanpassen
				$('#description').html($('option:selected', this).data('desc'));
				
                // Teken alle gemeentes
                // Eerst alle huidige gemeentes weg
                gg.selectAll('path').remove();
                
                minmaxavg(cbs_data);

            	var land_gem_data = loadData('gemeente-prov/topo_' + slider_value + '_cords.json');
            	
            	var dataset = {};
            	$.each(provincies, function (i, v) {
            		$.each(cbs_data[slider_value][i], function (j, w) {
                		// Als deze variabelen, dan delen door 100
                		if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
                			if (typeof w !== "object") {
                				if (w == "x") {
	                				dataset[j] == undefined;
                				}
                				else {
                					dataset[j] = parseFloat(w.replace(",", ".")) * 100;
                				}
                			}
                		}
                		else {
                			dataset[j] = w;
            			}
            		});
            	});
            	
            	provdata = cbs_data[slider_value]['__countrydata'];
            	
            	if (selected_variable == 'stedelijkheid.json') {
            		var max = provdata.min[2];
            		var min = provdata.max[2];
            	}
            	else {
            		var min = provdata.min[2];
            		var max = provdata.max[2];
            	}
            	
            	// Kleurschaal instellen met als range de min en max van de data
            	colorScale
            		    .range(colorbrewer.OrRd[8])
            		    .domain([min, max]);
            	
            	var coords = topojson.feature(land_gem_data, land_gem_data.objects['latlon_'+slider_value+'_cords']).features;
            	
            	// Gemeentes instellen, kleur, grootte, tooltip, click event, etc
            	gg.selectAll('path')
            		.data(coords)
            		.attr("id", function(d) { return d.properties.statnaam; })
            		.enter().append("g")
            		.attr("class", "gemeente")
            		.append("path")
            		.on("click", function (d) {
                		var current_provincie;
                		$.each(provincies_gemcode[slider_value], function(i, v) { //Jaar
                			if (v.indexOf(d.properties.statcode) != -1) {
                				current_provincie = i;
                			}
                		});
                		
            			zoom_prov(provincies_data[provincies_reverse[current_provincie]], d); 
            		})
            		.on('mouseover', function(d) {
        				var current_provincie;
        				$.each(provincies_gemcode[slider_value], function(i, v) { //Jaar
        					if (v.indexOf(d.properties.statcode) != -1) {
        						current_provincie = i;
        					}
        				});
        				
        				if (value == "x") {
        					value == "Geen data bekend";
        				}
        				else {
        					// Tooltips! Als bepaalde variabelen, dan delen door 100 omdat D3 decimale getallen niet leuk vindt
        					if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
        						var value = parseFloat(dataset[d.properties.statnaam] / 100).toLocaleString('nl');
        					}
        					else {
        						var value = parseFloat(dataset[d.properties.statnaam]).toLocaleString('nl');
        					}
        				}
            			
            			// Tooltip opvullen met gemeentenaam, waarde (geformat naar NL cijfers) met eenheid (% bijv)
            			tooltip.select('.label').html(provincies_reverse[current_provincie] + "<br /><strong>" + toTitleCase(d.properties.statnaam) + "</strong><br />" + parseFloat(value).toLocaleString('nl') + eenheid);
            			tooltip.style('display', 'block');
            		})
            		.on('mouseout', function(d) {
            			tooltip.style('display', 'none');
            		})
            		.on('mousemove', function(d) {
            			tooltip.style('top', (d3.event.pageY + 10) + 'px')
            		    	.style('left', (d3.event.pageX + 10) + 'px');
            		})
            		.attr("id", function(d) { return d.properties.statnaam })
            		.attr("d", path)
            		.attr("fill", function(d) {
            			if (dataset[d.properties.statnaam] === undefined) {
            				return '#ccc';
            			}
            			return colorScale(dataset[d.properties.statnaam]);
            		});
            		
        			if (selected_provincie != null) {
        		        // Legenda aanmaken
        		        legend();
        		        
        		        // Als gemeente geselecteerd, creëer chart
        				if (selected_gemeente != null) {
        					drawChart();
        				}
        				else {
        					// Anders treemap
        					drawTreemap();
        				}
        		    }
            		
                    legend();
                    svg.selectAll('g.provincies').remove();
				
			});
			
			// Functie redraw, aangeroepen door een verandering in de slider
			// Eigenlijk gebeurt hier hetzelfde als bij het veranderen van gegevensbron: 
			// inladen gemeentes en attributen instellen zoals hoogte en breedte, etc
			function redraw() {
				if (selected_variable.length) {
					cbs_data = loadData('convert/data/json/' + selected_variable);
					
					if (selected_provincie != null) {
						
                        legend();
						
						if (selected_gemeente != null) {
							drawChart();
						}
						else {
							drawTreemap();
						}
					}
					
					selected_type = $('#select_variable').find(":selected").data('type');
					
					// Eenheid aanpassen op basis van gekozen gegevensbron
					if (selected_type == "%") {
						eenheid = '%';
					}
					else {
						eenheid = '';
					}
					
					// Teken alle gemeentes
					// Eerst alle huidige gemeentes weg
					gg.selectAll('path').remove();
					
					var countrydata = cbs_data[slider_value]['__countrydata'];
					
					$('#description').html($('option:selected', this).data('desc'));
                    minmaxavg(cbs_data);
					
                	var land_gem_data = loadData('gemeente-prov/topo_' + slider_value + '_cords.json');
                	
                	var dataset = {};
                	$.each(provincies, function (i, v) {
                		$.each(cbs_data[slider_value][i], function (j, w) {
                			// Als deze variabelen, dan delen door 100
                			if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
                				if (typeof w !== "object") {
                					if (w == "x") {
                						dataset[j] == undefined;
                					}
                					else {
                						dataset[j] = parseFloat(w.replace(",", ".")) * 100;
                					}
                				}
                			}
                			else {
                				dataset[j] = w;
                			}
                		});
                	});
                	
                	provdata = cbs_data[slider_value]['__countrydata'];
                	
                	if (selected_variable == 'stedelijkheid.json') {
                		var max = provdata.min[2];
                		var min = provdata.max[2];
                	}
                	else {
                		var min = provdata.min[2];
                		var max = provdata.max[2];
                	}
                	
                	// Kleurschaal instellen met als range de min en max van de data
                	colorScale
                		    .range(colorbrewer.OrRd[8])
                		    .domain([min, max]);
                	
                	var coords = topojson.feature(land_gem_data, land_gem_data.objects['latlon_'+slider_value+'_cords']).features;
                	
                	// Gemeentes instellen, kleur, grootte, tooltip, click event, etc
                	gg.selectAll('path')
                		.data(coords)
                		.enter().append("g")
                		.attr("class", "gemeente")
                		.attr("id", function(d) { return d.properties.statnaam; })
                		.append("path")
                		.on("click", function (d) {
	                		var current_provincie;
	                		$.each(provincies_gemcode[slider_value], function(i, v) { //Jaar
                		    	if (v.indexOf(d.properties.statcode) != -1) {
                		    		current_provincie = i;
                		    	}
	                		});
	                	
                            console.log('zaaaaaming');
                			zoom_prov(provincies_data[provincies_reverse[current_provincie]], d); 
                		})
                		.on('mouseover', function(d) {
                			var current_provincie;
                			$.each(provincies_gemcode[slider_value], function(i, v) { //Jaar
                				if (v.indexOf(d.properties.statcode) != -1) {
                					current_provincie = i;
                				}
                			});
                			
                			if (value == "x") {
                				value == "Geen data bekend";
                			}
                			else {
	                			// Tooltips! Als bepaalde variabelen, dan delen door 100 omdat D3 decimale getallen niet leuk vindt
	                			if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
	                				var value = parseFloat(dataset[d.properties.statnaam] / 100).toLocaleString('nl');
	                			}
	                			else {
	                				var value = parseFloat(dataset[d.properties.statnaam]).toLocaleString('nl');
	                			}
                			}
                			
                			// Tooltip opvullen met gemeentenaam, waarde (geformat naar NL cijfers) met eenheid (% bijv)
                			tooltip.select('.label').html(provincies_reverse[current_provincie] + "<br /><strong>" + toTitleCase(d.properties.statnaam) + "</strong><br />" + value + eenheid);
                			tooltip.style('display', 'block');
                		})
                		.on('mouseout', function(d) {
                			tooltip.style('display', 'none');
                		})
                		.on('mousemove', function(d) {
                			tooltip.style('top', (d3.event.pageY + 10) + 'px')
                		    	.style('left', (d3.event.pageX + 10) + 'px');
                		})
                		.attr("id", function(d) { return d.properties.name })
                		.attr("d", path)
                		.attr("fill", function(d) {
                			if (dataset[d.properties.statnaam] === undefined) {
                				return '#ccc';
                			}
                			return colorScale(dataset[d.properties.statnaam]);
                		});
					
				}
			}
			
			// Aanmaken dataset voor de lijngrafiek en staafgrafiek
			function genDataset() {
				var dataset = [];
				
				$.each(yearRange, function (i, v) {
                    var obj = {'year': v}
                    obj[selected_variable] = cbs_data[v][selected_provincie.properties.PROV_NAME][selected_gemeente.properties.statnaam];
					dataset.push(obj); 
				});
				
				return dataset;
			}
			
            var second_data = [];
            var second_variable= '';
			// Deze functie wordt aangeroepen als er ingezoomd wordt op een gemeente
			// Radioboxes voor kiezen lijn/staaf aanmaken, aanroepen draw-functies 
			function drawChart() {
				$('#visual').empty();

                $('#visual').append('<label>Kies hier een tweede variabele om te vergelijken: </label><br/><select id="second_variable" name="Tweede Variabele">' +
                        '<option>Selecteer Variable</option>' +
                        '</select>');
                $.ajax({
                    'async': false,
                    'global': false,
                    'url': 'convert/data/json/expl.json',
                    'dataType': "json"
                }).done(function(data) {
                    // Groepen inladen
                    $.each(data, function(index) {
                        var options = '';
                        
                        keys = Object.keys(this),
                        i, len = keys.length;
                        
                        // Alfabetische volgorde van gegevensbronnen
                        keys.sort();
                        
                        // Options aanmaken
                        for (i = 0; i < len; i++)
                        {
                            k = keys[i];
                            if( this[k].Type === selected_type) {
                                options += '<option value="' + this[k].Filename + '" data-desc="' 
                                    + this[k].Desc + '" data-type="' + this[k].Type + '">' + k + '</option>';
                            }
                        }
                        
                        // Optionsgroup aanmaken en daarin options laden
                        $('#second_variable').append('<optgroup label="' + index + '">' + options + '</optgroup>');
                    });
                });
                $('#second_variable').change(function () {
                    second_data = [];
                    second_variable = $(this).val();
                    var data = loadData('convert/data/json/' + second_variable);
                    $.each(yearRange, function (i, v) {
                        var obj = {'year': v};
                        obj[second_variable] = data[v][selected_provincie.properties.PROV_NAME][selected_gemeente.properties.statnaam];
                        second_data.push(obj);
                    });
                    drawLineChart();
                });
                drawLineChart();
            }

			// Deze functie wordt aangeroepen om een linechart te bouwen
			// Instellen x en y-as, zie variabelenamen voor hun taak
			function drawLineChart() {
                $('#visual svg').remove();
                var dataset = genDataset();
                if (second_data.length > 0) {
                    $.each(dataset, function (i, e){
                        dataset[i][second_variable] = +second_data[i][second_variable];
                    });
                }
                
				var margin = {top: 20, right: 20, bottom: 30, left: 60},
				    width = $(".right").width() * 0.8,
				    height = width * 0.6;
				
				var x = d3.scale.ordinal()
				    .rangeRoundBands([0, width], .1);
				
				var y = d3.scale.linear()
				    .range([height, 0]);
				
				var xAxis = d3.svg.axis()
				    .scale(x)
				    .orient("bottom");
				    
				var yAxis = d3.svg.axis()
				    .scale(y)
				    .orient("left")
				    .tickFormat(function(d) { return parseFloat(d).toLocaleString('nl'); });
				
				// Als deze variabelen, dan delen door 100
				if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
					yAxis.tickFormat(function(d) { return d / 100; });
                    $.each(dataset, function (i, e) {
                        dataset[i][selected_variable] = parseInt(parseFloat(e[selected_variable].replace(",", ".")) * 100);
                    });
				}
				
				var svg = d3.select("#visual").append("svg")
				    .attr("width", width + margin.left + margin.right)
				    .attr("height", height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                
                var min = [],
                    max = [];

                $.each(dataset, function (i, v){
                    min.push(Math.floor(dataset[i][selected_variable] * 0.9));
                    max.push(Math.ceil(dataset[i][selected_variable] * 1.1));
                    if (second_variable) {
                        min.push(Math.floor(dataset[i][second_variable] * 0.9));
                        max.push(Math.ceil(dataset[i][second_variable] * 1.1));
                    }
                });

				min = d3.min(min);
			    max = d3.max(max);
					
                y.domain([min, max]);
                x.domain(yearRange);

                if (second_data.length > 0) {

                    var line = d3.svg.line()
                        .defined(function (d) { return d[selected_variable]; })
                        .x(function(d) { return x(d.year); })
                        .y(function(d) { return y(d[selected_variable]); });

                    var second_line = d3.svg.line()
                        .defined(function (d) { return d[second_variable]; })
                        .x(function(d) { return x(d.year); })
                        .y(function(d) { return y(d[second_variable]); });
                }
			    else{	
                    var line = d3.svg.line()
                        .defined(function (d) { return d[selected_variable]; })
                        .x(function(d) { return x(d.year); })
                        .y(function(d) { return y(d[selected_variable]); });
                }
				// Toevoegen x-as
				svg.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(-25," + height + ")")
					.call(xAxis);
				
				// Toevoegen y-as
				svg.append("g")
					.attr("class", "y axis")
					.call(yAxis)
					.append("text")	
					.attr("y", 6)
					.attr("x", 10)
					.attr("dy", ".71em")
					.style("text-anchor", "end")
					.text($('#select_variable').find(":selected").data('type'));
				
				// Lijn tekenen
				svg.append("path")
					.datum(dataset)
					.attr("class", "line")
					.attr("d", line);

                if (second_data) {
                    svg.append("path")
                        .datum(dataset)
                        .attr("class", "line2")
                        .attr("d", second_line);
                }
                
                var legend = svg.append("g")
                    .attr('class', 'legend')
                    .selectAll('g.legendEntry')
                    .data(function () {
                        if (second_variable){ 
                            return [{'color': 'steelblue', 
                                    'variable': selected_variable}, 
                                    {'color': 'red',
                                    'variable': second_variable}];
                        } return [{'color': 'steelblue', 'variable': selected_variable}];})
                    .enter()
                    .append('g').attr('class', 'legendEntry');

                legend.append('rect')
                    .attr("x", width - 200)
                    .attr("y", function (d, i) {
                        return (i * 20) + 5; })
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("stroke", "black")
                    .style("stroke-width", 1)
                    .style("fill", function (d) { return d.color; });

                legend.append('text')
                    .attr("x", width - 180)
                    .attr("y", function (d, i) {
                        return (i * 20) + 5;})
                    .attr("dy", "0.8em")
                    .text(function (d, i) {
                           return expl[d.variable]; 
                        });
                second_variable = '';
			}
			
			// Deze functie wordt aangeroepen om een treemap te bouwen op provincieniveau
			// Kies de juiste kinderen uit de volledige dataset (bijv provincie), reverse stedelijkheid, zie variabelenamen voor hun taak
			function drawTreemap() {
			
				$('#visual').empty();
				
				var margin = {top: 10, right: 0, bottom: 5, left: 0},
				    width = $(".right").width() * 0.95,
				    height = width * 0.7;
			
				var treemap = d3.layout.treemap()
				    .size([width, height])
				    .sticky(true);
				    
				if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
					treemap.value(function(d) { return d.value / 100; });
				}
				else if (selected_variable == 'stedelijkheid.json') {
					treemap.value(function(d) { return 6 - d.value; });
				}
				else {
				    treemap.value(function(d) { return d.value; });
				}
				
				var color = d3.scale.category20();
				
				var div = d3.select("#visual").append("div")
				    .style("position", "relative")
				    .style("width", (width + margin.left + margin.right) + "px")
				    .style("height", (height + margin.top + margin.bottom) + "px")
				    .style("left", margin.left + "px")
				    .style("top", margin.top + "px");
				
				d3.json("convert/data/json/tree_" + selected_variable, function(error, root) {
					if (error) throw error;
					
					var dataset;
					$.each(root.children, function(i, v) {
					    if (v.name == slider_value) {
					    	if (selected_provincie == null) {
					    		dataset = v;
					    		return;
					    	}
					    	else {
						        $.each(v.children, function(i, v) {
						            if (v.name == selected_provincie.properties.PROV_NAME) {
						                dataset = v;
						                return;
						            }
						        });
							}
					    }
					});
					
					var eenheid = '';
					if (selected_type == "%") {
						eenheid = "%";
					}
					
					var node = div.datum(dataset).selectAll(".node")
						.data(treemap.nodes)
						.enter()
						.append("div")
                        .on('mouseover', function (d) {
                            $('#'+d.name).attr('class', 'hover');
                        })
                        .on('mouseout', function (d) {
                            $('#'+d.name).attr('class', '');
                        })
						.attr("class", "node")
						.call(position)
						.style("background", function(d) { return color(d.name); })
                        .append("span")
                        .html(function(d) { return toTitleCase(d.name) + "<br>" + d.value.toLocaleString('nl') + ' ' + eenheid;});
				});
				
			}
			
			// Functie voor treemap positionering
			function position() {
				this.style("left", function(d) { return d.x + "px"; })
			      .style("top", function(d) { return d.y + "px"; })
			      .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
			      .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
			}
			
			// Zoom naar provincie, aangeroepen door click event provincie
			// Spreekt redelijk voor zich
			function zoom_prov(d, d2) {
				
				if (selected_variable == '') { alert('Selecteer eerst een gegevensbron'); return false; }
				
				$('#zoomout').css('visibility', 'visible');
				
				if (zoom_counter > 0) {
					var current_provincie;
					$.each(provincies_gemcode[slider_value], function(i, v) { //Jaar
					    $.each(v, function(j, w) { // Provincie
					    	if (v.indexOf(d2.properties.statcode) != -1) {
					    		current_provincie = i;
					    		
					    	}
					    });
					});
					
					var next_provincie = provincies_data[provincies_reverse[current_provincie]];
					
					if (selected_provincie == next_provincie) {
						//console.log(d2);
						zoom_gem(d2);
						//console.log('we gaan zoomen');
						return true;
					}
				}
				//console.log('zoom naar provincie');

				selected_gemeente = null;
				selected_gemeente_obj = null;
				$('#gemeente').html('');
				
				drawTreemap();
				selected_provincie = d;
				selected_provincie_obj = this;
                console.log(d);
                minmaxavg(cbs_data);
                //console.log(selected_provincie);
				$('#provincie').html("&raquo; " + d.properties.PROV_NAME);
				
				zoom_counter = 1;
				
				// Inzoomen
				var bounds = path.bounds(d),
					dx = bounds[1][0] - bounds[0][0],
					dy = bounds[1][1] - bounds[0][1],
					x = (bounds[0][0] + bounds[1][0]) / 2,
					y = (bounds[0][1] + bounds[1][1]) / 2,
					scale = 0.9 / Math.max(dx / width, dy / height),
					translate = [width / 2 - scale * x, height / 2 - scale * y];
				
				svg.transition()
					.duration(zoom_speed)
					.call(zoom.translate(translate).scale(scale).event);
				
			}
			
			// Deze functie wordt aangeroepen als er op een gemeente wordt geklikt
			// Aan de SVG wordt doorgegeven welke x en y punten er als hoeken gekozen moeten worden (zie bounds)
			// Tevens instellen variabelen welke gemeente geselecteerd is
			function zoom_gem(d) {
				if (selected_variable == '') { alert('Selecteer eerst een gegevensbron'); return false; }
				if (selected_gemeente_obj === this) { $('#gemeente').html(''); return reset_to_prov(); }
				//console.log('zoom naar gemeente');
				zoom_counter = 2;
				selected_gemeente = d;
				selected_gemeente_obj = this;
				
				$('#gemeente').html("&raquo; " + toTitleCase(d.properties.statnaam));
				
				var bounds = path.bounds(d),
					dx = bounds[1][0] - bounds[0][0],
					dy = bounds[1][1] - bounds[0][1],
					x = (bounds[0][0] + bounds[1][0]) / 2,
					y = (bounds[0][1] + bounds[1][1]) / 2,
					scale = 0.9 / Math.max(dx / width, dy / height),
					translate = [width / 2 - scale * x, height / 2 - scale * y];
				
				svg.transition()
					.duration(zoom_speed)
					.call(zoom.translate(translate).scale(scale).event);
				
				//$('#slider').hide();
				drawChart();
			    legend()
				
			}
			
			// Uitzoomen: gemeente -> prov
			function reset_to_prov() {
				zoom_counter = 1;
				
				//$('#slider').show();
				$('#visual').empty();
				drawTreemap();
				//console.log('reset naar provincie');
				selected_gemeente = null;
				selected_gemeente_obj = null;
				
				var bounds = path.bounds(selected_provincie),
					dx = bounds[1][0] - bounds[0][0],
					dy = bounds[1][1] - bounds[0][1],
					x = (bounds[0][0] + bounds[1][0]) / 2,
					y = (bounds[0][1] + bounds[1][1]) / 2,
					scale = 0.9 / Math.max(dx / width, dy / height),
					translate = [width / 2 - scale * x, height / 2 - scale * y];
				
				svg.transition()
					.duration(zoom_speed)
					.call(zoom.translate(translate).scale(scale).event);
				
			}
			
			// Uitzoomen: gemeente/provincie -> land
			function reset_to_land() {
				zoom_counter = 0;
				$('#zoomout').css('visibility', 'hidden');
				//$('#slider').show();
				$('#visual').empty();
				
				selected_provincie = null;
				selected_gemeente = null;
				$('#provincie').html('');
				$('#gemeente').html('');
				
				svg.transition()
				  .duration(zoom_speed)
				  .call(zoom.translate([0, 0]).scale(1).event);

                minmaxavg(cbs_data);
				if (zoom_counter > 0) {
					zoom_counter = 0;
					//console.log('reset naar land');
					//$('#slider').show();
					$('#visual').empty();
					
					selected_provincie = null;
					selected_gemeente = null;
					$('#provincie').html('');
					$('#gemeente').html('');
					
					svg.transition()
					  .duration(zoom_speed)
					  .call(zoom.translate([0, 0]).scale(1).event);
	
				}
			}
			
			// D3 zoom event
			function zoomed() {
				g.style("stroke-width", 1.5 / d3.event.scale + "px");
				g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
				gg.style("stroke-width", 1.5 / d3.event.scale + "px");
				gg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
				
			}
			
			// D3 supporting zoom
			function stopped() {
				if (d3.event.defaultPrevented) d3.event.stopPropagation();
			}
			
			// Gemeentenamen titlecase'n
			function toTitleCase(str)
			{
			    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
			}

            function minmaxavg(cbs_data) {
                //console.log(selected_provincie);
                if (selected_provincie) {
                    var countrydata = cbs_data[slider_value][selected_provincie.properties.PROV_NAME]['__provdata'];
                }
                else {
                    var countrydata = cbs_data[slider_value]['__countrydata'];
                }
                //console.log(countrydata);

                if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
                	var avg = (countrydata.avg / 100).toFixed(1);
                	var min = (countrydata.min[2] / 100).toFixed(1);
                	var max = (countrydata.max[2] / 100).toFixed(1);
                }
                else {
                	var avg = countrydata.avg.toFixed(1);
                	var min = countrydata.min[2].toFixed(1);
                	var max = countrydata.max[2].toFixed(1);
                }
                
                var html = '<p><strong>Gemiddelde:</strong> ' + avg + '</p>' +
                    '<p><strong>Min:</strong> <a id="min" href="#">' + toTitleCase(countrydata.min[1]) + ', ' + min + '</a></p>' +
                    '<p><strong>Max:</strong> <a id="max" href="#">' + toTitleCase(countrydata.max[1]) + ', ' + max + '</a></p>';
                $('#minmaxavg').empty();
                $('#minmaxavg').append(html);
                $('#min').on("click", function () {
                    var gemeente = $('#'+countrydata.min[1]);
                    gemeente.d3Click();
                    if ( zoomcounter !== 1 ){
                        gemeente.d3Click();
                    }
                });
                $('#max').on("click", function () {
                    var gemeente = $('#'+countrydata.max[1]);
                    gemeente.d3Click();
                    if ( zoomcounter !== 1 ){
                        gemeente.d3Click();
                    }
                });
                $('#min').hover( function () {
                    var gemeente = $('#'+countrydata.min[1]);
                    gemeente.attr('class', 'hover');
                    }, 
                    function () {
                    var gemeente = $('#'+countrydata.min[1]);
                    gemeente.attr('class', '');
                });
                $('#max').hover( function () {
                    var gemeente = $('#'+countrydata.max[1]);
                    gemeente.attr('class', 'hover');
                    }, 
                    function () {
                    var gemeente = $('#'+countrydata.max[1]);
                    gemeente.attr('class', '');
                });
            }

            // Legenda bouwen
            function legend(){
                remove_legend();
                
                var svg_legend = d3.select('#legend')
                	.append('svg')
                	.attr('width', 140)
                	.attr('height', 185);

                var legend = svg_legend.append('g')
                	.attr('class', 'legend')
                    .selectAll('g.legendEntry')
                    .data(colorScale.range())
                    .enter()
                    .append('g').attr('class', 'legendEntry');

                legend.append('rect')
                    .attr("x", 5)
                    .attr("y", function(d, i) {
                               return (i * 20) + 25;
                                   })
                    .attr("width", 10)
                    .attr("height", 10)
                    .style("stroke", "black")
                    .style("stroke-width", 1)
                    .style("fill", function(d){return d;}); 
                  //the data objects are the fill colors
				
				legend.append('text')
				    .attr("x", 5) //leave 5 pixel space after the 
				    .attr("y", 5)
				    .attr("dy", "0.8em") //place text one line *below* the x,y point
				    .text('Eenheid: ' + selected_type);
				
                legend.append('text')
                    .attr("x", 20) //leave 5 pixel space after the 
                    .attr("y", function(d, i) {
                                return (i * 20) + 25;
                            })
                    .attr("dy", "0.8em") //place text one line *below* the x,y point
                    .text(function(d,i) {
                        var extent = colorScale.invertExtent(d);
                        
                        //extent will be a two-element array, format it however you want:
                        var format = d3.format("1f");
                        
                        if (selected_variable == 'gemiddelde_huishoudensgrootte.json' || selected_variable == 'personenautos_per_huishouden.json') {
                        	return (+extent[0] / 100).toFixed(1) + " - " + (+extent[1] / 100).toFixed(1);
                        }
                        else {
                        	return format(+extent[0]) + " - " + format(+extent[1]);
                        }
                    });
            }
            svg.append('g')
            	.append('image')
            	.attr('id', 'zoomout')
            	.attr("x", width - 35)
            	.attr("y", 5)
            	.attr("width", 30)
            	.attr("height", 30)
            	.attr('xlink:href', 'img/zoomout.png')
            	.on('click', reset_to_land)
            	.style('visibility', 'hidden');
            
			
			// Legenda verwijderen
            function remove_legend(){
                $('#legend').empty();
            }
			
            $.fn.d3Click = function () {
                this.each(function (i, e) {
                    var evt = document.createEvent("MouseEvents");
                    evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                    e.dispatchEvent(evt);
                });
            };
		});
        </script>
	</body>
</html>
